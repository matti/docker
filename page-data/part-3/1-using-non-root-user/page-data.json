{"componentChunkName":"component---src-templates-course-content-template-js","path":"/part-3/1-using-non-root-user","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's go back to our youtube-dl application. The application could, in theory, escape the container due to a bug in docker/kernel. To mitigate this security issue we will add a non-root user to our container and run our process with that user. Another option would be to map the root user to a high, non-existing user id on the host with "},{"type":"element","tagName":"a","properties":{"href":"https://docs.docker.com/engine/security/userns-remap/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://docs.docker.com/engine/security/userns-remap/"}]},{"type":"text","value":", and can be used in case you must use root within the container."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Our status from the previous part was this:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" ubuntu"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"22.04\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" LC_ALL=C.UTF"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"8\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" apt"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"get update && apt"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"get install "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"y \\\n  curl python2 \\\n  && update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"alternatives "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"install /usr/bin/python python /usr/bin/python2 1\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" curl "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"L https"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//github.com/ytdl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"org/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl/releases/download/2021.12.17/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"o /usr/local/bin/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl \\\n  && chmod a+rx /usr/local/bin/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /app\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"/usr/local/bin/youtube-dl\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We will add an user \"app\" with"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" useradd "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"m app"}]}]}]},{"type":"element","tagName":"exercise","properties":{"name":"USER app"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And then we change user with the directive "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" - so all commands after this line will be executed as our new user, including the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" and "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" ubuntu"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"22.04\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" LC_ALL=C.UTF"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"8\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" apt"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"get update && apt"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"get install "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"y \\\n  curl python2 \\\n  && update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"alternatives "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"install /usr/bin/python python /usr/bin/python2 1\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" curl "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"L https"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//github.com/ytdl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"org/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl/releases/download/2021.12.17/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"o /usr/local/bin/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl \\\n  && chmod a+rx /usr/local/bin/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" useradd "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"m app\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"USER"}]},{"type":"text","value":" app\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /app\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"/usr/local/bin/youtube-dl\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]}]}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker compose build\n$ docker compose run youtube-dl-ubuntu https://imgur.com/JY5tHqr\n  [Imgur] JY5tHqr: Downloading webpage\n  ERROR: unable to open for writing: [Errno 13] Permission denied: 'Imgur-JY5tHqr.mp4.part'"}]}]}]}]},{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"vulnerabilities"},"children":[{"type":"element","tagName":"ul","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://snyk.io/blog/cve-2024-21626-runc-process-cwd-container-breakout/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://snyk.io/blog/cve-2024-21626-runc-process-cwd-container-breakout/"}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://www.openwall.com/lists/oss-security/2024/01/30/6","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://www.openwall.com/lists/oss-security/2024/01/30/6"}]}]},{"type":"text","value":"\n"}]}]}]},"html":"<div><p>Let's go back to our youtube-dl application. The application could, in theory, escape the container due to a bug in docker/kernel. To mitigate this security issue we will add a non-root user to our container and run our process with that user. Another option would be to map the root user to a high, non-existing user id on the host with <a href=\"https://docs.docker.com/engine/security/userns-remap/\" target=\"_blank\" rel=\"noopener noreferrer\">https://docs.docker.com/engine/security/userns-remap/</a>, and can be used in case you must use root within the container.</p><p>Our status from the previous part was this:</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> ubuntu<span class=\"token punctuation\">:</span>22.04\n<span class=\"token keyword\">ENV</span> LC_ALL=C.UTF<span class=\"token punctuation\">-</span>8\n\n<span class=\"token keyword\">RUN</span> apt<span class=\"token punctuation\">-</span>get update &amp;&amp; apt<span class=\"token punctuation\">-</span>get install <span class=\"token punctuation\">-</span>y \\\n  curl python2 \\\n  &amp;&amp; update<span class=\"token punctuation\">-</span>alternatives <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>install /usr/bin/python python /usr/bin/python2 1\n\n<span class=\"token keyword\">RUN</span> curl <span class=\"token punctuation\">-</span>L https<span class=\"token punctuation\">:</span>//github.com/ytdl<span class=\"token punctuation\">-</span>org/youtube<span class=\"token punctuation\">-</span>dl/releases/download/2021.12.17/youtube<span class=\"token punctuation\">-</span>dl <span class=\"token punctuation\">-</span>o /usr/local/bin/youtube<span class=\"token punctuation\">-</span>dl \\\n  &amp;&amp; chmod a+rx /usr/local/bin/youtube<span class=\"token punctuation\">-</span>dl\n\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">ENTRYPOINT</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/usr/local/bin/youtube-dl\"</span><span class=\"token punctuation\">]</span></code></pre></div><p>We will add an user \"app\" with</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">RUN</span> useradd <span class=\"token punctuation\">-</span>m app</code></pre></div><exercise name='USER app'><p>And then we change user with the directive <code class=\"language-text\">USER</code> - so all commands after this line will be executed as our new user, including the <code class=\"language-text\">WORKDIR</code> and <code class=\"language-text\">ENTRYPOINT</code>.</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> ubuntu<span class=\"token punctuation\">:</span>22.04\n<span class=\"token keyword\">ENV</span> LC_ALL=C.UTF<span class=\"token punctuation\">-</span>8\n\n<span class=\"token keyword\">RUN</span> apt<span class=\"token punctuation\">-</span>get update &amp;&amp; apt<span class=\"token punctuation\">-</span>get install <span class=\"token punctuation\">-</span>y \\\n  curl python2 \\\n  &amp;&amp; update<span class=\"token punctuation\">-</span>alternatives <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>install /usr/bin/python python /usr/bin/python2 1\n\n<span class=\"token keyword\">RUN</span> curl <span class=\"token punctuation\">-</span>L https<span class=\"token punctuation\">:</span>//github.com/ytdl<span class=\"token punctuation\">-</span>org/youtube<span class=\"token punctuation\">-</span>dl/releases/download/2021.12.17/youtube<span class=\"token punctuation\">-</span>dl <span class=\"token punctuation\">-</span>o /usr/local/bin/youtube<span class=\"token punctuation\">-</span>dl \\\n  &amp;&amp; chmod a+rx /usr/local/bin/youtube<span class=\"token punctuation\">-</span>dl\n\n<span class=\"token keyword\">RUN</span> useradd <span class=\"token punctuation\">-</span>m app\n\n<span class=\"token keyword\">USER</span> app\n<span class=\"token keyword\">WORKDIR</span> /app\n\n<span class=\"token keyword\">ENTRYPOINT</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/usr/local/bin/youtube-dl\"</span><span class=\"token punctuation\">]</span></code></pre></div><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker compose build\n$ docker compose run youtube-dl-ubuntu https://imgur.com/JY5tHqr\n  [Imgur] JY5tHqr: Downloading webpage\n  ERROR: unable to open for writing: [Errno 13] Permission denied: &#39;Imgur-JY5tHqr.mp4.part&#39;</code></pre></div></exercise><text-box variant='learningObjectives' name='vulnerabilities'><ul>\n<li><a href=\"https://snyk.io/blog/cve-2024-21626-runc-process-cwd-container-breakout/\" target=\"_blank\" rel=\"noopener noreferrer\">https://snyk.io/blog/cve-2024-21626-runc-process-cwd-container-breakout/</a></li>\n<li><a href=\"https://www.openwall.com/lists/oss-security/2024/01/30/6\" target=\"_blank\" rel=\"noopener noreferrer\">https://www.openwall.com/lists/oss-security/2024/01/30/6</a></li>\n</ul></text-box></div>","frontmatter":{"path":"/part-3/1-using-non-root-user","title":"Using a non-root user"},"fileAbsolutePath":"/Users/mpa/dev/docker-hy/data/part-3/section-1.md"},"allPages":{"edges":[{"node":{"id":"948f83e9-b338-5b95-ae2d-a7c680eadb0c","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"fe138126-ea55-51b2-a071-8a7532aa51af","frontmatter":{"path":"/part-2","title":"Part 2"}}},{"node":{"id":"8147ba2c-1cbf-5878-b301-ef847e624e70","frontmatter":{"path":"/part-3/2-development","title":"Development with Docker"}}},{"node":{"id":"ed0e0aae-16de-5de9-8877-77337c24124f","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"1b7ed2f7-c954-577b-ac8d-cae5f2dfc838","frontmatter":{"path":"/part-2/2-docker-networking","title":"More Docker networking"}}},{"node":{"id":"3a0a776d-ec13-50e5-ade2-6c0d549f58ba","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"ad6b1fb2-b897-54c5-8ce5-00acf0c99caf","frontmatter":{"path":"/part-2/3-wordpress","title":"Wordpress"}}},{"node":{"id":"cea7278b-6d74-539e-b105-29dc780024b6","frontmatter":{"path":"/part-1/2-running-and-stopping","title":"Running and stopping containers"}}},{"node":{"id":"83f82958-678d-500e-8ce0-a2d587fed9c1","frontmatter":{"path":"/part-1/3-in-depth-dive-to-images","title":"In-depth dive to images"}}},{"node":{"id":"087c95a9-00b7-523d-bc13-85d227b71193","frontmatter":{"path":"/part-1/7-summary","title":"Summary"}}},{"node":{"id":"d3b909df-cb77-59a6-8402-f961bd2a7aff","frontmatter":{"path":"/part-1/5-volumes-and-ports","title":"Interacting with the container via volumes and ports"}}},{"node":{"id":"e8a51e48-cc89-5f08-8c00-2c3abe47d5a9","frontmatter":{"path":"/","title":"About this course"}}},{"node":{"id":"455aef79-d091-56bd-bace-e566c89238bb","frontmatter":{"path":"/part-1/1-getting-started","title":"Definitions and basic concepts"}}},{"node":{"id":"2b806816-8c59-5a3a-9b89-da8548d44e0a","frontmatter":{"path":"/part-1/4-defining-start-conditions","title":"Defining start conditions for the container"}}},{"node":{"id":"a3fe4972-edce-5bc7-9eb5-b355fac1ebf8","frontmatter":{"path":"/part-2/1-migrating-to-docker-compose","title":"Migrating to docker compose"}}},{"node":{"id":"3447594d-f3e4-56a2-8d83-12bf7ff5f3a4","frontmatter":{"path":"/part-3/1-using-non-root-user","title":"Using a non-root user"}}},{"node":{"id":"bc9490fd-c9f8-5a6a-8370-2ef946d4e3fa","frontmatter":{"path":"/part-3/4-extras","title":"Extras"}}},{"node":{"id":"67016067-426f-51cc-8ea0-3e16da657b13","frontmatter":{"path":"/part-3/3-multi-host-environments","title":"Multi-host environments"}}}]}},"pageContext":{}},"staticQueryHashes":["3294351120","994120085"]}