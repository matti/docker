{"componentChunkName":"component---src-templates-course-content-template-js","path":"/part-2/1-migrating-to-docker-compose","result":{"data":{"page":{"htmlAst":{"type":"element","tagName":"div","properties":{},"children":[{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"docker-compose"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Even with a simple image, we've already been dealing with plenty of command line options in both building, pushing and running the image."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Next we will switch to a tool called "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker-compose"}]},{"type":"text","value":" to manage these."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"docker-compose is designed to simplify running multi-container applications to using a single command."}]}]},{"type":"element","tagName":"text-box","properties":{"variant":"learningObjectives","name":"docker compose"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Recently, "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker"}]},{"type":"text","value":" has "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker-compose"}]},{"type":"text","value":" built-in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker compose"}]},{"type":"text","value":" - see "},{"type":"element","tagName":"a","properties":{"href":"https://docs.docker.com/compose/compose-v2/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://docs.docker.com/compose/compose-v2/"}]}]}]},{"type":"element","tagName":"exercise","properties":{"name":"docker-compose.yml"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In the folder where we have our Dockerfile with the following content:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" ubuntu"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"22.04\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" LC_ALL=C.UTF"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"8\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" apt"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"get update && apt"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"get install "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"y \\\n  curl python2 \\\n  && update"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"alternatives "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"install /usr/bin/python python /usr/bin/python2 1\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" curl "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"L https"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//github.com/ytdl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"org/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl/releases/download/2021.12.17/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"o /usr/local/bin/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl \\\n    && chmod a+rx /usr/local/bin/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /app\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"/usr/local/bin/youtube-dl\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"we create a file called "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"youtube-dl/docker-compose.yml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'3.8'"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"youtube-dl-ubuntu"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"ubuntu\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"build"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" ."}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The version setting is not very strict, it just needs to be above 2 because otherwise the syntax is significantly different. See "},{"type":"element","tagName":"a","properties":{"href":"https://docs.docker.com/compose/compose-file/","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://docs.docker.com/compose/compose-file/"}]},{"type":"text","value":" for more info. The key "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"build:"}]},{"type":"text","value":" value can be set to a path (ubuntu), have an object with "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"context"}]},{"type":"text","value":" and "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"dockerfile"}]},{"type":"text","value":" keys or reference a "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"url of a git repository"}]},{"type":"text","value":"."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now we can build and push with just these commands:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"docker compose build\ndocker compose push"}]}]}]}]},{"type":"element","tagName":"exercise","properties":{"name":"Volumes in docker-compose"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"To run the image as we did previously, we will need to add the volume bind mounts. Volumes in docker-compose are defined with the following syntax "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"location-in-host:location-in-container"}]},{"type":"text","value":". Compose can work without an absolute path:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'3.8'"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"youtube-dl-ubuntu"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"ubuntu\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"build"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" .\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" ."},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/app"}]}]}]}]},{"type":"element","tagName":"exercise","properties":{"name":"run"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The service name can be used to run it:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"docker compose run youtube-dl-ubuntu https://imgur.com/JY5tHqr"}]}]}]}]},{"type":"element","tagName":"exercise","properties":{"name":"Alpine Variant"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Given "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"youtube-dl/Dockerfile.alpine"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"dockerfile"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-dockerfile"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"FROM"}]},{"type":"text","value":" alpine"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"latest\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENV"}]},{"type":"text","value":" LC_ALL=C.UTF"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"8\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" apk add curl \\\n  && curl "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"L https"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//github.com/ytdl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"org/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl/releases/download/2021.12.17/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"o /usr/local/bin/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl \\\n  && chmod +x /usr/local/bin/youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl \\\n  && apk del curl\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"RUN"}]},{"type":"text","value":" apk add python3\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"WORKDIR"}]},{"type":"text","value":" /app\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"ENTRYPOINT"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"/usr/local/bin/youtube-dl\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Add "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"youtube-dl-alpine"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"Answer:"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"youtube-dl/docker-compose.yml"}]}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'3.8'"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"youtube-dl-ubuntu"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"ubuntu\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"build"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"dockerfile"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Dockerfile.ubuntu\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" ."},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/app\n\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"youtube-dl-alpine"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" youtube"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"dl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"alpine\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"build"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"dockerfile"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Dockerfile.alpine\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" ."},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/app"}]}]}]}]},{"type":"element","tagName":"exercise","properties":{"name":"jwilder/whoami"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Compose is really meant for running web services, so let's move from simple binary wrappers to running a HTTP service."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://github.com/jwilder/whoami","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://github.com/jwilder/whoami"}]},{"type":"text","value":" is a simple service that prints the current container id (hostname)."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"docker container run -p 8000:8000 jwilder/whoami"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Navigate with a browser or curl to localhost:8000, they both will answer with the id."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Take down the container so that it's not blocking port 8000."}]}]},{"type":"element","tagName":"exercise","properties":{"name":"whoami/docker-compose.yml"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's create a new folder and a docker-compose file "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"whoami/docker-compose.yml"}]},{"type":"text","value":" from the command line options."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'3'"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"whoami"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jwilder/whoami\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ports"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" 8000"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"8000"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Test it:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"docker compose up\ncurl localhost:8000"}]}]}]}]},{"type":"element","tagName":"exercise","properties":{"name":"scaling"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Compose can also scale the service to run multiple instances:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker compose up --scale whoami=3\n\n  WARNING: The \"whoami\" service specifies a port on the host. If multiple containers for this service are created on a single host, the port will clash.\n\n  Starting whoami_whoami_1 ... done\n  Creating whoami_whoami_2 ... error\n  Creating whoami_whoami_3 ... error"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The command fails due to a port clash, as each instance will attempt to bind to the same host port (8000)."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can get around this by only specifying the container port. As mentioned in "},{"type":"element","tagName":"a","properties":{"href":"/part1/#allowing-external-connections-into-containers"},"children":[{"type":"text","value":"part 1"}]},{"type":"text","value":", when leaving the host port unspecified, Docker will automatically choose a free port."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Update the ports definition in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker-compose.yml"}]},{"type":"text","value":":"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'3'"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"whoami"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jwilder/whoami\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ports"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"8000"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then run the command again:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker compose up --scale whoami=3\n  Starting whoami_whoami_1 ... done\n  Creating whoami_whoami_2 ... done\n  Creating whoami_whoami_3 ... done"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"All three instances are now running and listening on random host ports. We can use "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker compose port"}]},{"type":"text","value":" to find out which ports the instances are bound to."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker compose port --index 1 whoami 8000\n  0.0.0.0:32770\n\n$ docker compose port --index 2 whoami 8000\n  0.0.0.0:32769\n\n$ docker compose port --index 3 whoami 8000\n  0.0.0.0:32768"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We can now curl from these ports:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ curl 0.0.0.0:32769\n  I'm 536e11304357\n\n$ curl 0.0.0.0:32768\n  I'm 1ae20cd990f7"}]}]}]}]},{"type":"element","tagName":"exercise","properties":{"name":"Load Balancer"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In a server environment you'd often have a load balancer in-front of the service. For local environment (or a single server) one good solution is to use "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/jwilder/nginx-proxy","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://github.com/jwilder/nginx-proxy"}]},{"type":"text","value":" that configures nginx from docker daemon as containers are started and stopped."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's add the proxy to our compose file and remove the port bindings from the whoami service. We'll mount our "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker.sock"}]},{"type":"text","value":" inside of the container in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":":ro"}]},{"type":"text","value":" read-only mode."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"3\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"whoami"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jwilder/whoami\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"proxy"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jwilder/nginx"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"proxy\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" /var/run/docker.sock"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/tmp/docker.sock"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"ro\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ports"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","datetime","number"]},"children":[{"type":"text","value":"80:80"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"When we start this and test"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker compose up -d --scale whoami=3\n$ curl localhost:80\n  <html>\n  <head><title>503 Service Temporarily Unavailable</title></head>\n  <body bgcolor=\"white\">\n  <center><h1>503 Service Temporarily Unavailable</h1></center>\n  <hr><center>nginx/1.13.8</center>\n  </body>\n  </html>"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It's \"working\", but the nginx just doesn't know which service we want. The "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"nginx-proxy"}]},{"type":"text","value":" works with two environment variables: "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"VIRTUAL_HOST"}]},{"type":"text","value":" and "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"VIRTUAL_PORT"}]},{"type":"text","value":". "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"VIRTUAL_PORT"}]},{"type":"text","value":" is not needed if the service has "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"EXPOSE"}]},{"type":"text","value":" in it's docker image. We can see that "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"jwilder/whoami"}]},{"type":"text","value":" sets it: "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/jwilder/whoami/blob/master/Dockerfile#L9","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"https://github.com/jwilder/whoami/blob/master/Dockerfile#L9"}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Note:"}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The domain "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"colasloth.com"}]},{"type":"text","value":" is configured so that all subdomains point to "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"127.0.0.1"}]},{"type":"text","value":". More information about how this works can be found at "},{"type":"element","tagName":"a","properties":{"href":"https://colasloth.github.io","target":"_blank","rel":["noopener","noreferrer"]},"children":[{"type":"text","value":"colasloth.github.io"}]},{"type":"text","value":", but in brief it's a simple DNS \"hack\". Several other domains serving the same purpose exist, such as "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"localtest.me"}]},{"type":"text","value":", "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"lvh.me"}]},{"type":"text","value":", and "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"vcap.me"}]},{"type":"text","value":", to name a few. In any case, let's use "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"colasloth.com"}]},{"type":"text","value":" here:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"version"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"3\""}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"services"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"whoami"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jwilder/whoami\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"environment"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" VIRTUAL_HOST=whoami.colasloth.com\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"proxy"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" jwilder/nginx"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"proxy\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" /var/run/docker.sock"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/tmp/docker.sock"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"ro\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"ports"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","datetime","number"]},"children":[{"type":"text","value":"80:80"}]}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now the proxy works:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker compose up -d --scale whoami=3\n$ curl whoami.colasloth.com\n  I'm f6f85f4848a8\n$ curl whoami.colasloth.com\n  I'm 740dc0de1954"}]}]}]}]},{"type":"element","tagName":"exercise","properties":{"name":"nginx hello & world"},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Let's add couple of more containers behind the same proxy. We can use the official "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"nginx"}]},{"type":"text","value":" image to serve a simple static web page. We don't have to even build the container images, we can just mount the content to the image. Let's prepare some content for two services called \"hello\" and \"world\"."}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"echo \"hello\" > hello.html\necho \"world\" > world.html"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then add these services to the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"docker-compose.yml"}]},{"type":"text","value":" file where you mount just the content as "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"index.html"}]},{"type":"text","value":" in the default nginx path:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"hello"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nginx"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"1.19"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"alpine\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" ./hello.html"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/usr/share/nginx/html/index.html"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"ro\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"environment"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" VIRTUAL_HOST=hello.colasloth.com\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"world"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" nginx"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"1.19"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"alpine\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"volumes"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" ./world.html"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"/usr/share/nginx/html/index.html"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"ro\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"environment"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" VIRTUAL_HOST=world.colasloth.com"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now let's test:"}]},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"console"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-console"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-console"]},"children":[{"type":"text","value":"$ docker compose up -d --scale whoami=3\n$ curl hello.colasloth.com\n  hello\n\n$ curl world.colasloth.com\n  world\n\n$ curl whoami.colasloth.com\n  I'm f6f85f4848a8\n\n$ curl whoami.colasloth.com\n  I'm 740dc0de1954"}]}]}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now we have a basic single machine hosting setup up and running."}]},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Test updating the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"hello.html"}]},{"type":"text","value":" without restarting the container, does it work?"}]}]}]},"html":"<div><text-box variant='learningObjectives' name='docker-compose'><p>Even with a simple image, we've already been dealing with plenty of command line options in both building, pushing and running the image.</p><p>Next we will switch to a tool called <code class=\"language-text\">docker-compose</code> to manage these.</p><p>docker-compose is designed to simplify running multi-container applications to using a single command.</p></text-box><text-box variant='learningObjectives' name='docker compose'><p>Recently, <code class=\"language-text\">docker</code> has <code class=\"language-text\">docker-compose</code> built-in <code class=\"language-text\">docker compose</code> - see <a href=\"https://docs.docker.com/compose/compose-v2/\" target=\"_blank\" rel=\"noopener noreferrer\">https://docs.docker.com/compose/compose-v2/</a></p></text-box><exercise name='docker-compose.yml'><p>In the folder where we have our Dockerfile with the following content:</p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> ubuntu<span class=\"token punctuation\">:</span>22.04\n<span class=\"token keyword\">ENV</span> LC_ALL=C.UTF<span class=\"token punctuation\">-</span>8\n\n<span class=\"token keyword\">RUN</span> apt<span class=\"token punctuation\">-</span>get update &amp;&amp; apt<span class=\"token punctuation\">-</span>get install <span class=\"token punctuation\">-</span>y \\\n  curl python2 \\\n  &amp;&amp; update<span class=\"token punctuation\">-</span>alternatives <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>install /usr/bin/python python /usr/bin/python2 1\n\n<span class=\"token keyword\">RUN</span> curl <span class=\"token punctuation\">-</span>L https<span class=\"token punctuation\">:</span>//github.com/ytdl<span class=\"token punctuation\">-</span>org/youtube<span class=\"token punctuation\">-</span>dl/releases/download/2021.12.17/youtube<span class=\"token punctuation\">-</span>dl <span class=\"token punctuation\">-</span>o /usr/local/bin/youtube<span class=\"token punctuation\">-</span>dl \\\n    &amp;&amp; chmod a+rx /usr/local/bin/youtube<span class=\"token punctuation\">-</span>dl\n\n<span class=\"token keyword\">WORKDIR</span> /app\n<span class=\"token keyword\">ENTRYPOINT</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/usr/local/bin/youtube-dl\"</span><span class=\"token punctuation\">]</span></code></pre></div><p>we create a file called <strong>youtube-dl/docker-compose.yml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.8'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">youtube-dl-ubuntu</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> youtube<span class=\"token punctuation\">-</span>dl<span class=\"token punctuation\">-</span>ubuntu\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> .</code></pre></div><p>The version setting is not very strict, it just needs to be above 2 because otherwise the syntax is significantly different. See <a href=\"https://docs.docker.com/compose/compose-file/\" target=\"_blank\" rel=\"noopener noreferrer\">https://docs.docker.com/compose/compose-file/</a> for more info. The key <code class=\"language-text\">build:</code> value can be set to a path (ubuntu), have an object with <code class=\"language-text\">context</code> and <code class=\"language-text\">dockerfile</code> keys or reference a <code class=\"language-text\">url of a git repository</code>.</p><p>Now we can build and push with just these commands:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">docker compose build\ndocker compose push</code></pre></div></exercise><exercise name='Volumes in docker-compose'><p>To run the image as we did previously, we will need to add the volume bind mounts. Volumes in docker-compose are defined with the following syntax <code class=\"language-text\">location-in-host:location-in-container</code>. Compose can work without an absolute path:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.8'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">youtube-dl-ubuntu</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> youtube<span class=\"token punctuation\">-</span>dl<span class=\"token punctuation\">-</span>ubuntu\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span> .\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> .<span class=\"token punctuation\">:</span>/app</code></pre></div></exercise><exercise name='run'><p>The service name can be used to run it:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">docker compose run youtube-dl-ubuntu https://imgur.com/JY5tHqr</code></pre></div></exercise><exercise name=\"Alpine Variant\"><p>Given <strong>youtube-dl/Dockerfile.alpine</strong></p><div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> alpine<span class=\"token punctuation\">:</span>latest\n\n<span class=\"token keyword\">ENV</span> LC_ALL=C.UTF<span class=\"token punctuation\">-</span>8\n\n<span class=\"token keyword\">RUN</span> apk add curl \\\n  &amp;&amp; curl <span class=\"token punctuation\">-</span>L https<span class=\"token punctuation\">:</span>//github.com/ytdl<span class=\"token punctuation\">-</span>org/youtube<span class=\"token punctuation\">-</span>dl/releases/download/2021.12.17/youtube<span class=\"token punctuation\">-</span>dl <span class=\"token punctuation\">-</span>o /usr/local/bin/youtube<span class=\"token punctuation\">-</span>dl \\\n  &amp;&amp; chmod +x /usr/local/bin/youtube<span class=\"token punctuation\">-</span>dl \\\n  &amp;&amp; apk del curl\n\n<span class=\"token keyword\">RUN</span> apk add python3\n\n<span class=\"token keyword\">WORKDIR</span> /app\n\n<span class=\"token keyword\">ENTRYPOINT</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/usr/local/bin/youtube-dl\"</span><span class=\"token punctuation\">]</span></code></pre></div><p>Add <code class=\"language-text\">youtube-dl-alpine</code></p><p><strong>Answer:</strong></p><p><strong>youtube-dl/docker-compose.yml</strong></p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.8'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">youtube-dl-ubuntu</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> youtube<span class=\"token punctuation\">-</span>dl<span class=\"token punctuation\">-</span>ubuntu\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile.ubuntu\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> .<span class=\"token punctuation\">:</span>/app\n\n  <span class=\"token key atrule\">youtube-dl-alpine</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> youtube<span class=\"token punctuation\">-</span>dl<span class=\"token punctuation\">-</span>alpine\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile.alpine\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> .<span class=\"token punctuation\">:</span>/app</code></pre></div></exercise><exercise name=\"jwilder/whoami\"><p>Compose is really meant for running web services, so let's move from simple binary wrappers to running a HTTP service.</p><p><a href=\"https://github.com/jwilder/whoami\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/jwilder/whoami</a> is a simple service that prints the current container id (hostname).</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">docker container run -p 8000:8000 jwilder/whoami</code></pre></div><p>Navigate with a browser or curl to localhost:8000, they both will answer with the id.</p><p>Take down the container so that it's not blocking port 8000.</p></exercise><exercise name=\"whoami/docker-compose.yml\"><p>Let's create a new folder and a docker-compose file <code class=\"language-text\">whoami/docker-compose.yml</code> from the command line options.</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">whoami</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/whoami\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 8000<span class=\"token punctuation\">:</span><span class=\"token number\">8000</span></code></pre></div><p>Test it:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">docker compose up\ncurl localhost:8000</code></pre></div></exercise><exercise name=\"scaling\"><p>Compose can also scale the service to run multiple instances:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker compose up --scale whoami=3\n\n  WARNING: The &quot;whoami&quot; service specifies a port on the host. If multiple containers for this service are created on a single host, the port will clash.\n\n  Starting whoami_whoami_1 ... done\n  Creating whoami_whoami_2 ... error\n  Creating whoami_whoami_3 ... error</code></pre></div><p>The command fails due to a port clash, as each instance will attempt to bind to the same host port (8000).</p><p>We can get around this by only specifying the container port. As mentioned in <a href=\"/part1/#allowing-external-connections-into-containers\">part 1</a>, when leaving the host port unspecified, Docker will automatically choose a free port.</p><p>Update the ports definition in <code class=\"language-text\">docker-compose.yml</code>:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">whoami</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/whoami\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token number\">8000</span></code></pre></div><p>Then run the command again:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker compose up --scale whoami=3\n  Starting whoami_whoami_1 ... done\n  Creating whoami_whoami_2 ... done\n  Creating whoami_whoami_3 ... done</code></pre></div><p>All three instances are now running and listening on random host ports. We can use <code class=\"language-text\">docker compose port</code> to find out which ports the instances are bound to.</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker compose port --index 1 whoami 8000\n  0.0.0.0:32770\n\n$ docker compose port --index 2 whoami 8000\n  0.0.0.0:32769\n\n$ docker compose port --index 3 whoami 8000\n  0.0.0.0:32768</code></pre></div><p>We can now curl from these ports:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ curl 0.0.0.0:32769\n  I&#39;m 536e11304357\n\n$ curl 0.0.0.0:32768\n  I&#39;m 1ae20cd990f7</code></pre></div></exercise><exercise name=\"Load Balancer\"><p>In a server environment you'd often have a load balancer in-front of the service. For local environment (or a single server) one good solution is to use <a href=\"https://github.com/jwilder/nginx-proxy\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/jwilder/nginx-proxy</a> that configures nginx from docker daemon as containers are started and stopped.</p><p>Let's add the proxy to our compose file and remove the port bindings from the whoami service. We'll mount our <code class=\"language-text\">docker.sock</code> inside of the container in <code class=\"language-text\">:ro</code> read-only mode.</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3\"</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">whoami</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/whoami\n  <span class=\"token key atrule\">proxy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/nginx<span class=\"token punctuation\">-</span>proxy\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/tmp/docker.sock<span class=\"token punctuation\">:</span>ro\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token datetime number\">80:80</span></code></pre></div><p>When we start this and test</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker compose up -d --scale whoami=3\n$ curl localhost:80\n  &lt;html&gt;\n  &lt;head&gt;&lt;title&gt;503 Service Temporarily Unavailable&lt;/title&gt;&lt;/head&gt;\n  &lt;body bgcolor=&quot;white&quot;&gt;\n  &lt;center&gt;&lt;h1&gt;503 Service Temporarily Unavailable&lt;/h1&gt;&lt;/center&gt;\n  &lt;hr&gt;&lt;center&gt;nginx/1.13.8&lt;/center&gt;\n  &lt;/body&gt;\n  &lt;/html&gt;</code></pre></div><p>It's \"working\", but the nginx just doesn't know which service we want. The <code class=\"language-text\">nginx-proxy</code> works with two environment variables: <code class=\"language-text\">VIRTUAL_HOST</code> and <code class=\"language-text\">VIRTUAL_PORT</code>. <code class=\"language-text\">VIRTUAL_PORT</code> is not needed if the service has <code class=\"language-text\">EXPOSE</code> in it's docker image. We can see that <code class=\"language-text\">jwilder/whoami</code> sets it: <a href=\"https://github.com/jwilder/whoami/blob/master/Dockerfile#L9\" target=\"_blank\" rel=\"noopener noreferrer\">https://github.com/jwilder/whoami/blob/master/Dockerfile#L9</a></p><p>Note:</p><p>The domain <code class=\"language-text\">colasloth.com</code> is configured so that all subdomains point to <code class=\"language-text\">127.0.0.1</code>. More information about how this works can be found at <a href=\"https://colasloth.github.io\" target=\"_blank\" rel=\"noopener noreferrer\">colasloth.github.io</a>, but in brief it's a simple DNS \"hack\". Several other domains serving the same purpose exist, such as <code class=\"language-text\">localtest.me</code>, <code class=\"language-text\">lvh.me</code>, and <code class=\"language-text\">vcap.me</code>, to name a few. In any case, let's use <code class=\"language-text\">colasloth.com</code> here:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3\"</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">whoami</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/whoami\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> VIRTUAL_HOST=whoami.colasloth.com\n  <span class=\"token key atrule\">proxy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> jwilder/nginx<span class=\"token punctuation\">-</span>proxy\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/tmp/docker.sock<span class=\"token punctuation\">:</span>ro\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token datetime number\">80:80</span></code></pre></div><p>Now the proxy works:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker compose up -d --scale whoami=3\n$ curl whoami.colasloth.com\n  I&#39;m f6f85f4848a8\n$ curl whoami.colasloth.com\n  I&#39;m 740dc0de1954</code></pre></div></exercise><exercise name=\"nginx hello & world\"><p>Let's add couple of more containers behind the same proxy. We can use the official <code class=\"language-text\">nginx</code> image to serve a simple static web page. We don't have to even build the container images, we can just mount the content to the image. Let's prepare some content for two services called \"hello\" and \"world\".</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">echo &quot;hello&quot; &gt; hello.html\necho &quot;world&quot; &gt; world.html</code></pre></div><p>Then add these services to the <code class=\"language-text\">docker-compose.yml</code> file where you mount just the content as <code class=\"language-text\">index.html</code> in the default nginx path:</p><div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">hello</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.19<span class=\"token punctuation\">-</span>alpine\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ./hello.html<span class=\"token punctuation\">:</span>/usr/share/nginx/html/index.html<span class=\"token punctuation\">:</span>ro\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> VIRTUAL_HOST=hello.colasloth.com\n<span class=\"token key atrule\">world</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> nginx<span class=\"token punctuation\">:</span>1.19<span class=\"token punctuation\">-</span>alpine\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ./world.html<span class=\"token punctuation\">:</span>/usr/share/nginx/html/index.html<span class=\"token punctuation\">:</span>ro\n  <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> VIRTUAL_HOST=world.colasloth.com</code></pre></div><p>Now let's test:</p><div class=\"gatsby-highlight\" data-language=\"console\"><pre class=\"language-console\"><code class=\"language-console\">$ docker compose up -d --scale whoami=3\n$ curl hello.colasloth.com\n  hello\n\n$ curl world.colasloth.com\n  world\n\n$ curl whoami.colasloth.com\n  I&#39;m f6f85f4848a8\n\n$ curl whoami.colasloth.com\n  I&#39;m 740dc0de1954</code></pre></div><p>Now we have a basic single machine hosting setup up and running.</p><p>Test updating the <code class=\"language-text\">hello.html</code> without restarting the container, does it work?</p></exercise></div>","frontmatter":{"path":"/part-2/1-migrating-to-docker-compose","title":"Migrating to docker compose"},"fileAbsolutePath":"/Users/mpa/dev/docker-hy/data/part-2/section-1.md"},"allPages":{"edges":[{"node":{"id":"948f83e9-b338-5b95-ae2d-a7c680eadb0c","frontmatter":{"path":"/frontmatter-guide","title":"Frontmatter-guide"}}},{"node":{"id":"67016067-426f-51cc-8ea0-3e16da657b13","frontmatter":{"path":"/part-3/3-multi-host-environments","title":"Multi-host environments"}}},{"node":{"id":"bc9490fd-c9f8-5a6a-8370-2ef946d4e3fa","frontmatter":{"path":"/part-3/4-extras","title":"Extras"}}},{"node":{"id":"fe138126-ea55-51b2-a071-8a7532aa51af","frontmatter":{"path":"/part-2","title":"Part 2"}}},{"node":{"id":"8147ba2c-1cbf-5878-b301-ef847e624e70","frontmatter":{"path":"/part-3/2-development","title":"Development with Docker"}}},{"node":{"id":"ed0e0aae-16de-5de9-8877-77337c24124f","frontmatter":{"path":"/part-3","title":"Part 3"}}},{"node":{"id":"1b7ed2f7-c954-577b-ac8d-cae5f2dfc838","frontmatter":{"path":"/part-2/2-docker-networking","title":"More Docker networking"}}},{"node":{"id":"3a0a776d-ec13-50e5-ade2-6c0d549f58ba","frontmatter":{"path":"/part-1","title":"Part 1"}}},{"node":{"id":"ad6b1fb2-b897-54c5-8ce5-00acf0c99caf","frontmatter":{"path":"/part-2/3-wordpress","title":"Wordpress"}}},{"node":{"id":"cea7278b-6d74-539e-b105-29dc780024b6","frontmatter":{"path":"/part-1/2-running-and-stopping","title":"Running and stopping containers"}}},{"node":{"id":"83f82958-678d-500e-8ce0-a2d587fed9c1","frontmatter":{"path":"/part-1/3-in-depth-dive-to-images","title":"In-depth dive to images"}}},{"node":{"id":"087c95a9-00b7-523d-bc13-85d227b71193","frontmatter":{"path":"/part-1/7-summary","title":"Summary"}}},{"node":{"id":"d3b909df-cb77-59a6-8402-f961bd2a7aff","frontmatter":{"path":"/part-1/5-volumes-and-ports","title":"Interacting with the container via volumes and ports"}}},{"node":{"id":"e8a51e48-cc89-5f08-8c00-2c3abe47d5a9","frontmatter":{"path":"/","title":"About this course"}}},{"node":{"id":"455aef79-d091-56bd-bace-e566c89238bb","frontmatter":{"path":"/part-1/1-getting-started","title":"Definitions and basic concepts"}}},{"node":{"id":"2b806816-8c59-5a3a-9b89-da8548d44e0a","frontmatter":{"path":"/part-1/4-defining-start-conditions","title":"Defining start conditions for the container"}}},{"node":{"id":"a3fe4972-edce-5bc7-9eb5-b355fac1ebf8","frontmatter":{"path":"/part-2/1-migrating-to-docker-compose","title":"Migrating to docker compose"}}},{"node":{"id":"3447594d-f3e4-56a2-8d83-12bf7ff5f3a4","frontmatter":{"path":"/part-3/1-using-non-root-user","title":"Using a non-root user"}}}]}},"pageContext":{}},"staticQueryHashes":["3294351120","994120085"]}